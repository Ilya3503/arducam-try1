<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–ª–∞–∫–∞ —Ç–æ—á–µ–∫</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div class="w-full max-w-7xl p-6 bg-white shadow-2xl rounded-2xl grid grid-cols-2 gap-6">

    <!-- –õ–µ–≤–∞—è –ø–æ–ª–æ–≤–∏–Ω–∞: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è + —Å—é–¥–∞ –±—É–¥—É—Ç –ø–æ–ø–∞–¥–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
    <div class="col-span-1 flex flex-col">
      <div class="flex-1 bg-gradient-to-r from-blue-500 to-indigo-600 p-6 rounded-2xl shadow-lg text-white flex flex-col">
        <h2 class="text-2xl font-semibold mb-4">üìÑ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</h2>
        <div id="info-block"
             class="flex-1 p-4 bg-white/20 rounded-lg text-sm whitespace-pre-wrap overflow-auto">
          –ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...
        </div>
      </div>
    </div>

    <!-- –ü—Ä–∞–≤–∞—è –ø–æ–ª–æ–≤–∏–Ω–∞ -->
    <div class="col-span-1 flex flex-col space-y-6">

      <!-- –ö–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ—Ö–æ–¥–∞ -->
      <div class="w-full flex justify-end gap-2">
        <a href="index.html"
           class="py-1 px-3 bg-blue-500 text-white text-sm font-medium rounded-lg shadow hover:bg-blue-600 transition">
          New1
        </a>
        <a href="info.html"
           class="py-1 px-3 bg-green-500 text-white text-sm font-medium rounded-lg shadow hover:bg-green-600 transition">
          Info
        </a>
      </div>

      <!-- –ü—Ä–µ–≤—å—é (—Å–ø—Ä–∞–≤–∞ —Å–≤–µ—Ä—Ö—É) -->
      <div class="bg-gradient-to-r from-green-500 to-emerald-600 p-6 rounded-2xl shadow-lg text-white">
        <h2 class="text-xl font-semibold mb-4">üì∑ –ü—Ä–µ–≤—å—é (–¥–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏)</h2>
        <form id="preview-form" class="space-y-4">
          <label class="block">
            <span class="font-semibold">–ü—Ä–æ–µ–∫—Ü–∏—è:</span>
            <select id="preview-projection" class="w-full mt-1 p-2 rounded-xl text-gray-700">
              <option value="xy">XY</option>
              <option value="xz">XZ</option>
              <option value="yz">YZ</option>
            </select>
          </label>
          <button
            type="button"
            class="w-full py-2 px-4 bg-white text-green-600 font-semibold rounded-xl shadow hover:bg-gray-100 transition"
            onclick="loadPreview()">
            –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–µ–≤—å—é
          </button>
        </form>
      </div>

      <!-- –ü—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥ (—Å–ø—Ä–∞–≤–∞ —Å–Ω–∏–∑—É) -->
      <div class="flex-1 bg-gradient-to-r from-purple-500 to-pink-600 p-6 rounded-2xl shadow-lg text-white flex flex-col">
        <h2 class="text-2xl font-semibold mb-4">‚öôÔ∏è –ü—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥</h2>
        <form id="preprocess-form" class="space-y-4 flex-1 flex flex-col">
          <label class="block">
            <span class="font-semibold">–†–∞–∑–º–µ—Ä –≤–æ–∫—Å–µ–ª—è:</span>
            <input type="number" id="voxel-size" value="0.01" step="0.01" class="w-full mt-1 p-2 rounded-xl text-gray-700" />
          </label>
          <label class="block">
            <span class="font-semibold">–ü—Ä–æ–µ–∫—Ü–∏—è:</span>
            <select id="process-projection" class="w-full mt-1 p-2 rounded-xl text-gray-700">
              <option value="xy">XY</option>
              <option value="xz">XZ</option>
              <option value="yz">YZ</option>
            </select>
          </label>
          <button
            type="button"
            class="mt-auto w-full py-2 px-4 bg-white text-purple-600 font-semibold rounded-xl shadow hover:bg-gray-100 transition"
            onclick="runPreprocess()">
            –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥
          </button>
        </form>
      </div>
    </div>
  </div>

  <script>
    // --- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –±–∞–∑–æ–≤—ã–µ URL –¥–ª—è API
    const API_BASE_8003 = `${window.location.protocol}//${window.location.hostname}:8003`;

    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–≤—å—é -> –≤—Å—Ç–∞–≤–∫–∞ –≤ –ª–µ–≤—ã–π –±–ª–æ–∫
    async function loadPreview() {
      const projection = document.getElementById("preview-projection").value;
      try {
        console.log('–ó–∞–ø—Ä–æ—Å –ø—Ä–µ–≤—å—é —Å –ø—Ä–æ–µ–∫—Ü–∏–µ–π:', projection);
        const url = `${API_BASE_8003}/preview_before_preprocess?projection=${projection}`;
        console.log('URL:', url);

        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP error: ${res.status}`);

        const data = await res.json();
        console.log('–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ:', data);

        document.getElementById("info-block").innerHTML =
          `<p class="mb-2">[–ü—Ä–µ–≤—å—é] –§–∞–π–ª: <b>${data.file}</b>, –ø—Ä–æ–µ–∫—Ü–∏—è: <b>${data.projection}</b></p>
           <img src="data:image/png;base64,${data.preview_base64}" alt="preview" class="mx-auto rounded-lg shadow-lg w-full h-auto"/>`;
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–≤—å—é:', err);
        document.getElementById("info-block").innerHTML =
          `<span class="text-red-300">–û—à–∏–±–∫–∞: ${err.message}</span>`;
      }
    }

    // –ü—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥ -> –≤—Å—Ç–∞–≤–∫–∞ –≤ –ª–µ–≤—ã–π –±–ª–æ–∫
    async function runPreprocess() {
      const voxelSize = document.getElementById("voxel-size").value;
      const projection = document.getElementById("process-projection").value;
      try {
        console.log('–ó–∞–ø—Ä–æ—Å –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥–∞:', { voxelSize, projection });
        const url = `${API_BASE_8003}/preprocess?voxel_size=${voxelSize}&projection=${projection}`;
        console.log('URL:', url);

        const res = await fetch(url, {
          method: "POST"
        });
        if (!res.ok) throw new Error(`HTTP error: ${res.status}`);

        const data = await res.json();
        console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥–∞:', data);

        document.getElementById("info-block").innerHTML =
          `<p class="mb-2">[–ü—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥] –§–∞–π–ª: <b>${data.file}</b><br/> –í–æ–∫—Å–µ–ª—å: <b>${data.voxel_size}</b><br/>–ü—Ä–æ–µ–∫—Ü–∏—è: <b>${data.projection}</b></p>
           <img src="data:image/png;base64,${data.preview_base64}" alt="processed" class="mx-auto rounded-lg shadow-lg w-full h-auto"/>`;
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥–∞:', err);
        document.getElementById("info-block").innerHTML =
          `<span class="text-red-300">–û—à–∏–±–∫–∞: ${err.message}</span>`;
      }
    }
  </script>

</body>
</html>