<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞–º–µ—Ä–æ–π</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- HTMX -->
  <script src="https://unpkg.com/htmx.org@1.9.9"></script>
</head>

<body class="bg-gray-50 min-h-screen flex items-center justify-center">

  <div class="w-4/5 max-w-6x1 p-10 bg-white shadow-xl rounded-2xl space-y-12 border border-gray-200">

    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="flex justify-between items-center border-b pb-4">
      <h1 class="text-3xl font-bold text-gray-800">üì° –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞–º–µ—Ä–æ–π</h1>
      <div class="flex gap-2">
        <a href="preview.html"
           class="py-1.5 px-4 bg-emerald-600 text-white text-sm font-medium rounded-lg shadow hover:bg-emerald-700 transition">
          Preview
        </a>
      </div>
    </div>

    <!-- –ë–ª–æ–∫ 1: –ü—Ä–æ—Å–º–æ—Ç—Ä —Ñ–∞–π–ª–æ–≤ -->
    <section class="rounded-xl border border-gray-200 bg-gray-50 p-6 shadow-sm">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">üìÇ –ü—Ä–æ—Å–º–æ—Ç—Ä —Ñ–∞–π–ª–æ–≤</h2>

      <div id="files-view"
           class="p-4 bg-white border border-gray-200 rounded-lg text-sm text-gray-700 min-h-[150px] overflow-auto max-h-[300px]">
        –ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤...
      </div>

      <button
        type="button"
        class="mt-4 w-full py-2 px-4 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition"
        onclick="fetchFilesList()">
        üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
      </button>
    </section>

    <!-- –ë–ª–æ–∫ 2: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–º–µ—Ä–æ–π -->
    <section class="rounded-xl border border-gray-200 bg-gray-50 p-6 shadow-sm">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">üé• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–º–µ—Ä–æ–π</h2>

      <div id="camera-process"
           class="p-4 bg-white border border-gray-200 rounded-lg text-sm text-gray-700 min-h-[150px]">
        –ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞...
      </div>

      <button
        type="button"
        class="mt-4 w-full py-2 px-4 bg-emerald-600 text-white font-medium rounded-lg hover:bg-emerald-700 transition"
        onclick="fetchCameraProcess()">
        ‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å
      </button>
    </section>

  </div>

  <script>
    const API_BASE_8001 = `${window.location.protocol}//${window.location.hostname}:8001`;

    // ---------- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ----------
    function renderFilesList(data) {
      if (data.status && data.status.includes("–û—à–∏–±–∫–∞")) {
        return `<div class="text-red-600 font-medium">${data.message}</div>`;
      }

      if (!data.capture_dirs) {
        return `<div class="text-gray-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ñ–∞–π–ª–∞—Ö</div>`;
      }

      let html = `
        <div class="mb-2 text-sm text-gray-600">
          <span class="font-semibold text-gray-800">–°—Ç–∞—Ç—É—Å:</span> ${data.status}
        </div>
        <div class="divide-y divide-gray-200">
      `;
      for (const [dir, files] of Object.entries(data.capture_dirs)) {
        html += `
          <div class="py-2">
            <div class="font-semibold text-gray-800">${dir}</div>
            ${files.length
              ? `<ul class="ml-4 list-disc text-gray-600">
                  ${files.map(f => `<li>${f}</li>`).join("")}
                </ul>`
              : `<div class="ml-4 text-gray-500 italic">(–Ω–µ—Ç —Ñ–∞–π–ª–æ–≤)</div>`}
          </div>`;
      }
      html += "</div>";
      return html;
    }

    function renderCameraProcess(data) {
      if (data.detail) {
        return `<div class="text-red-600 font-medium">${data.detail}</div>`;
      }

      return `
        <div class="space-y-3">
          <div><span class="font-semibold text-gray-800">–°—Ç–∞—Ç—É—Å:</span> ${data.status}</div>
          <div><span class="font-semibold text-gray-800">–§–∞–π–ª:</span> ${data.ply_file}</div>
          <div>
            <span class="font-semibold text-gray-800">–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è:</span>
            <div class="ml-3 text-gray-700">
              <div><b>–°—Ç–∞—Ç—É—Å:</b> ${data.visualization?.status || "-"}</div>
              <div><b>–°–æ–æ–±—â–µ–Ω–∏–µ:</b> ${data.visualization?.message || "-"}</div>
            </div>
          </div>
        </div>`;
    }

    // ---------- API-–∑–∞–ø—Ä–æ—Å—ã ----------
    async function fetchFilesList() {
      const el = document.getElementById('files-view');
      el.innerHTML = '<div class="text-gray-400 italic">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
      try {
        const response = await fetch(`${API_BASE_8001}/files`);
        const data = await response.json();
        el.innerHTML = renderFilesList(data);
      } catch (err) {
        el.innerHTML = `<div class="text-red-600">–û—à–∏–±–∫–∞: ${err.message}</div>`;
      }
    }

    async function fetchCameraProcess() {
      const el = document.getElementById('camera-process');
      el.innerHTML = '<div class="text-gray-400 italic">–ó–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...</div>';
      try {
        const response = await fetch(`${API_BASE_8001}/process`);
        const data = await response.json();
        el.innerHTML = renderCameraProcess(data);
      } catch (err) {
        el.innerHTML = `<div class="text-red-600">–û—à–∏–±–∫–∞: ${err.message}</div>`;
      }
    }
  </script>

</body>
</html>
